---
pagetitle: "Pillar 1 and 2 COVID-19 cases"
lang: "en-GB"
output:
  html_document:
    css: styles.css
    highlight: null
    mathjax: null
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse) ; library(sf) ; library(rvest) ; library(httr) ; library(readxl) ;
library(crosstalk) ; library(reactable) ; library(leaflet) ; library(htmltools) ; library(shiny)

# Upper tier local authority boundaries
# Source: Open Geography Portal, ONS
# URL: https://geoportal.statistics.gov.uk/datasets/counties-and-unitary-authorities-december-2019-boundaries-uk-bgc/data

utla <- st_read("https://opendata.arcgis.com/datasets/29827d4c079349888acd7db3f84e3449_0.geojson") %>% 
  filter(str_detect(ctyua19cd, "^E")) %>% 
  select(area_code = `ctyua19cd`, long, lat)

# Weekly rate of COVID-19 cases by UTLA for Pillar 1 and 2
# Source: National COVID-19 surveillance reports, Public Health England
# URL: https://www.gov.uk/government/publications/national-covid-19-surveillance-reports

# check date!!
period <- "22 and 28 June 2020"

tmp <- tempfile(fileext = ".xlsx")
url <- read_html("https://www.gov.uk/government/publications/national-covid-19-surveillance-reports") %>% 
  html_nodes("a") %>%
  html_attr("href") %>%
  str_subset("\\.xlsx") %>% 
  .[[1]]

GET(url = url,
    write_disk(tmp))

cases <- read_xlsx(tmp, sheet = 10, skip = 7) %>% 
  select(area_code = `UTLA code`, area_name = `UTLA name`, rate = `Rate per 100,000 population`) %>%
  mutate(rate = as.numeric(rate),
         rate = replace_na(rate, 0))

# Transform the data
df <- cases %>% 
  # join UTLA centroids
  left_join(st_set_geometry(utla, NULL), by = "area_code") %>% 
  # add popup
  mutate(popup = str_c("<strong>", area_name, "</strong><br/><strong>", rate, "</strong> cases per 100,000") %>% map(HTML))

# Create a shared data frame
sd <- SharedData$new(df, group = "area_name")
sd_tbl <- df %>% select(area_name, rate) %>%
  SharedData$new(group = "area_name")
```

```{r filter}
filter <- filter_slider(id = "rate", label = "Cases per 100,000", sharedData = sd, column = ~rate, step = 1, ticks = FALSE)
```


```{r map}
map <- leaflet(data = sd, width = "100%", height = 550) %>%
  setView(-2.07811, 53.23497, zoom = 6) %>% 
  addTiles(urlTemplate = "https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png", attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a> | <a href="https://www.ons.gov.uk/methodology/geography/licences">Contains OS data Â© Crown copyright and database right (2020)</a> | Data: <a href="https://www.gov.uk/government/publications/national-covid-19-surveillance-reports" target="_blank">Public Health England</a>') %>%
  addPolygons(data = utla, fillColor = "#EAEAEA", fillOpacity = 0.3, weight = 1, color = "#bdbdbd")  %>% 
  addCircleMarkers(lng = ~long, lat = ~lat, radius = ~sqrt(rate), fillColor = "#57AACB", fillOpacity = 0.8, weight = 1, color = "#FFFFFF", opacity = 1, label = ~popup, labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "13px", direction = "auto"))
```

```{r table}
tbl <- reactable(sd_tbl,
                 defaultPageSize = 10,
                 paginationType = "simple",
                 compact = FALSE,
                 borderless = TRUE,
                 wrap = FALSE,
                 resizable = TRUE,
                 searchable = TRUE,
                 defaultSorted = "rate",
                 defaultSortOrder = "desc",
                 defaultColDef = colDef(align = "left"),
                 selection = "multiple",
                 onClick = "select",
                 rowStyle = list(cursor = "pointer"),
                 columns = list(
                   area_name = colDef(name = "Upper Tier Local Authority",
                                      align = "left"),
                   rate = colDef(name = "Cases per 100,000",
                                 align = "left")
                   )
                 )
```
<main>
```{r ui}
div(class = "container-fluid",
  div(class = "subtitle",
      h1(class = "title", "Weekly rate of COVID-19 cases per 100,000 population tested under ", a("Pillar 1 and 2", href = 'https://www.gov.uk/government/publications/coronavirus-covid-19-scaling-up-testing-programmes/coronavirus-covid-19-scaling-up-our-testing-programmes', target = "_blank"), " by Upper Tier Local Authority in England"), 
      paste0("New cases between ", period)
      ),
  br(),
  div(class = "row",
      div(class = "col-sm-6", map),
      div(class = "col-sm-6", list(filter, tbl))
      )
  )
```
</main>
<script>
  // Add aria-label to the crosstalk selection button from the Leaflet map. Map may not have initialised at this point so set up an interval to keep calling until it has
  var updateSelectionButtonFn = setInterval(updateSelectionButton, 100);
  
  function updateSelectionButton() {
    try {
      // We don't have an id or name so have to do it by classname and then check we have the correct button by testing the 'title' attribute
      var arrEasyButtons = document.getElementsByClassName('easy-button-button');
  
      for (var i = 0; i < arrEasyButtons.length; i++) {
        if (arrEasyButtons[i].title == "Make a selection") {
          // set aria-label to describe the function of the button
          arrEasyButtons[i].setAttribute('aria-label', 'Define an area on the map and filter the dataset to only that area.');
          
          clearInterval(updateSelectionButtonFn);  // cancel any further calls to this function as we have completed all actions
        }
      }
    }
    catch(e) {
      clearInterval(updateSelectionButtonFn);   // something went wrong so cancel fn call
    }
  }
  
  
  // Add type="hidden" attribute to all form elements with classname "irs-hidden-input" to remove errors in
  // WAVE due to the inputs not having labels. (NOTE these are elements to hold the values for slider widgets)
  // The controls may not have initialised at this point so set up an interval to keep calling until they have
  var addInputHiddenFn = setInterval(addInputHidden, 500);
  
  function addInputHidden() {
    try {
      var arrHiddenInputs = document.getElementsByClassName('irs-hidden-input');
    
      if (arrHiddenInputs.length > 0) {
        for (var i = 0; i < arrHiddenInputs.length; i++) {
          arrHiddenInputs[i].setAttribute('type', 'hidden');
        }
        
        clearInterval(addInputHiddenFn);   // cancel any further calls to this function as we have completed all actions
      }
    }
    catch(e) {
      clearInterval(addInputHiddenFn);   // something went wrong so cancel fn call
    }
  }
  
  
  // Remove label tags created by crosstalk for the checkboxes and sliders as they cause validation errors,
  // and replace them with fieldsets and legends containing the text of the label
  // Reason for the error is that the 'for' attribute isn't referencing an id of a form control
  // NOTE: the do while loop always references array index 0 because as the elements are removed from the DOM they are also removed from the array
  var arrFormLabels = document.getElementsByClassName('control-label');
  var parent;
  var labelText;
  var newNode;
  var fieldset;
  var legend;
  
  do {
    parent = arrFormLabels[0].parentNode;                   // container of the label
    labelText = arrFormLabels[0].firstChild.textContent;    // get the label text we want to preserve
    
    // create the new fieldset and legend nodes first
    legend = document.createElement('legend');
    legend.appendChild(document.createTextNode(labelText));
    legend.setAttribute('class', 'formGroupHeading');
    fieldset = document.createElement('fieldset');
    fieldset.appendChild(legend);
    
    parent.removeChild(arrFormLabels[0]);   // remove the old label
    
    // Now add all the children of parent to the newly created fieldset
    while (parent.childNodes.length > 0) {
      fieldset.appendChild(parent.childNodes[0]);
    }
    
    parent.appendChild(fieldset);    // add the fieldset to the parent
    
    // For the slider widgets we also need to add an aria-label to describe the purpose of the group
    if (parent.classList.contains('crosstalk-input-slider')) {
      parent.setAttribute('aria-label', 'Slider range control for ' + labelText);
      parent.setAttribute('tabindex', '0');    // allow the slider group to be accessed via tab
    }
  }
  while (arrFormLabels.length > 0);
  
  
  // Add aria-labels to the slider components
  // The inner controls may not have initialised at this point so set up an interval to keep calling until they have
  var slidersFn = setInterval(sliders, 500);
  
  function sliders() {
    try {
      var arrSliders = document.getElementsByClassName('crosstalk-input-slider');   // The div surrounding the control group
    
      var arrMinValues = document.getElementsByClassName('irs-min');          // range min label
      var arrMaxValues = document.getElementsByClassName('irs-max');          // range max label
      var arrFromValues = document.getElementsByClassName('irs-from');        // range from label
      var arrToValues = document.getElementsByClassName('irs-to');            // range to label
      var arrSingleValues = document.getElementsByClassName('irs-single');    // range from - to label
      var arrSliderHandles = document.getElementsByClassName('irs-slider');   // the handles on the sliders
      
      if (arrFromValues.length == arrSliders.length) {
        // We know how many sliders there are on the page as their containers are written into the HTML.
        // The actual slider widgets are dynamically created within them at runtime.
        // If the array lengths match we know that the widgets have all been created
        for (var i = 0; i < arrSliders.length; i++) {
          arrMinValues[i].setAttribute('aria-label', 'Minimum range value');
          arrMaxValues[i].setAttribute('aria-label', 'Maximum range value');
          arrFromValues[i].setAttribute('aria-label', 'Lower range value');
          arrToValues[i].setAttribute('aria-label', 'Upper range value');
          arrSingleValues[i].setAttribute('aria-label', 'Range values');
        }
        
        // these are the slider handles
        for (var i = 0; i < arrSliderHandles.length; i++) {
          arrSliderHandles[i].setAttribute('aria-label', 'slider handle');    // not using role="slider" as unfortunately this control doesn't seem to conform to the WAI-ARIA specification for the slider role
        }
        
        clearInterval(slidersFn);   // cancel any further calls to this function as we have completed all actions
      }
    }
    catch(e) {
      clearInterval(slidersFn);   // something went wrong so cancel fn call
    }
  }
</script>